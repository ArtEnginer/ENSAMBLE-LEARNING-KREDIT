{% extends "base.html" %}

{% block title %}Prediksi Kredit - Sistem Prediksi Kredit{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto space-y-6 fade-in">
    <!-- Page Header -->
    <div class="card-android material-shadow p-6">
        <div class="flex items-center space-x-3">
            <div class="bg-primary p-3 rounded-lg">
                <i class="fas fa-calculator text-white text-2xl"></i>
            </div>
            <div>
                <h2 class="text-2xl font-bold text-gray-800">Prediksi Kredit</h2>
                <p class="text-gray-500">Isi form di bawah untuk menganalisis kelayakan kredit</p>
            </div>
        </div>
    </div>

    <!-- Progress Steps -->
    <div class="card-android material-shadow p-6">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-2 step-indicator active" data-step="1">
                <div class="step-circle">1</div>
                <span class="hidden md:inline text-sm font-medium">Data Pribadi</span>
            </div>
            <div class="flex-1 h-1 bg-gray-200 mx-2"></div>
            <div class="flex items-center space-x-2 step-indicator" data-step="2">
                <div class="step-circle">2</div>
                <span class="hidden md:inline text-sm font-medium">Info Kredit</span>
            </div>
            <div class="flex-1 h-1 bg-gray-200 mx-2"></div>
            <div class="flex items-center space-x-2 step-indicator" data-step="3">
                <div class="step-circle">3</div>
                <span class="hidden md:inline text-sm font-medium">Prescreening</span>
            </div>
        </div>
    </div>

    <form id="predictionForm" class="space-y-6">
        <!-- Step 1: Data Pribadi -->
        <div class="form-step active" id="step1">
            <div class="card-android material-shadow p-6">
                <div class="flex items-center space-x-2 mb-6 pb-4 border-b-2 border-primary">
                    <i class="fas fa-user text-primary text-xl"></i>
                    <h3 class="text-xl font-bold text-gray-800">Data Pribadi Pemohon</h3>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-birthday-cake mr-1 text-primary"></i> Tanggal Lahir *
                        </label>
                        <input type="date" name="tanggal_lahir" id="tanggal_lahir" required
                            class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-primary transition-all">
                        <p class="text-xs text-gray-500 mt-1">Usia akan dihitung otomatis</p>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-briefcase mr-1 text-primary"></i> Pekerjaan *
                        </label>
                        <select name="pekerjaan" id="pekerjaan" required
                            class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-primary transition-all">
                            <option value="">-- Pilih Pekerjaan --</option>
                            {% for value, label in pekerjaan_options.items() %}
                            <option value="{{ value }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-heart mr-1 text-primary"></i> Status Pernikahan *
                        </label>
                        <div class="grid grid-cols-3 gap-2">
                            {% for value, label in status_pernikahan_options.items() %}
                            <label class="radio-card">
                                <input type="radio" name="status_pernikahan" value="{{ value }}" required
                                    class="hidden">
                                <div class="radio-card-inner">
                                    <i class="fas fa-check-circle"></i>
                                    <span>{{ label }}</span>
                                </div>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div class="flex justify-end mt-6">
                    <button type="button" onclick="nextStep(2)"
                        class="px-8 py-3 bg-primary text-white rounded-lg font-semibold hover:bg-primaryDark transition-colors material-shadow flex items-center space-x-2">
                        <span>Lanjut</span>
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 2: Info Kredit -->
        <div class="form-step" id="step2" style="display: none;">
            <div class="card-android material-shadow p-6">
                <div class="flex items-center space-x-2 mb-6 pb-4 border-b-2 border-primary">
                    <i class="fas fa-credit-card text-primary text-xl"></i>
                    <h3 class="text-xl font-bold text-gray-800">Informasi Kredit</h3>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-money-bill-wave mr-1 text-primary"></i> Plafond (Rp) *
                        </label>
                        <div class="relative">
                            <span
                                class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500 font-semibold">Rp</span>
                            <input type="text" name="plafond" id="plafond" required placeholder="0"
                                class="w-full pl-12 pr-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-primary transition-all text-right text-lg font-semibold">
                        </div>
                        <div class="mt-2 flex flex-wrap gap-2">
                            <button type="button" onclick="setPlafond(50000000)" class="quick-amount-btn">50
                                Juta</button>
                            <button type="button" onclick="setPlafond(100000000)" class="quick-amount-btn">100
                                Juta</button>
                            <button type="button" onclick="setPlafond(200000000)" class="quick-amount-btn">200
                                Juta</button>
                            <button type="button" onclick="setPlafond(500000000)" class="quick-amount-btn">500
                                Juta</button>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-calendar-alt mr-1 text-primary"></i> Jangka Waktu *
                        </label>
                        <div class="flex items-center space-x-3">
                            <input type="range" name="jangka_waktu" id="jangka_waktu" required min="12" max="360"
                                step="12" value="60" class="flex-1" oninput="updateTenorDisplay(this.value)">
                            <div class="bg-primary text-white px-4 py-2 rounded-lg font-bold min-w-[100px] text-center">
                                <span id="tenorDisplay">60</span> bulan
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">12 bulan - 360 bulan (30 tahun)</p>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-box mr-1 text-primary"></i> Produk *
                        </label>
                        <select name="produk" id="produk" required
                            class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-primary transition-all">
                            <option value="">-- Pilih Produk --</option>
                            {% for produk in produk_options %}
                            <option value="{{ produk }}">{{ produk }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-cubes mr-1 text-primary"></i> Sub Produk *
                        </label>
                        <select name="sub_produk" id="sub_produk" required
                            class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-primary transition-all">
                            <option value="">-- Pilih Sub Produk --</option>
                            {% for sub_produk in sub_produk_options %}
                            <option value="{{ sub_produk }}">{{ sub_produk }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="flex justify-between mt-6">
                    <button type="button" onclick="prevStep(1)"
                        class="px-8 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition-colors flex items-center space-x-2">
                        <i class="fas fa-arrow-left"></i>
                        <span>Kembali</span>
                    </button>
                    <button type="button" onclick="nextStep(3)"
                        class="px-8 py-3 bg-primary text-white rounded-lg font-semibold hover:bg-primaryDark transition-colors material-shadow flex items-center space-x-2">
                        <span>Lanjut</span>
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 3: Prescreening -->
        <div class="form-step" id="step3" style="display: none;">
            <div class="card-android material-shadow p-6">
                <div class="flex items-center space-x-2 mb-6 pb-4 border-b-2 border-primary">
                    <i class="fas fa-clipboard-check text-primary text-xl"></i>
                    <h3 class="text-xl font-bold text-gray-800">Hasil Prescreening</h3>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">



                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-id-card mr-1 text-primary"></i> Hasil SIPKUR *
                        </label>
                        <select name="hasil_prescreening_sipkur" id="hasil_prescreening_sipkur" required
                            class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-primary transition-all">
                            <option value="">-- Pilih Hasil SIPKUR --</option>
                            {% for status in hasil_prescreening_sipkur_options %}
                            <option value="{{ status }}">{{ status }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-address-card mr-1 text-primary"></i> Hasil Dukcapil *
                        </label>
                        <select name="hasil_prescreening_dukcapil" id="hasil_prescreening_dukcapil" required
                            class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-primary transition-all">
                            <option value="">-- Pilih Hasil Dukcapil --</option>
                            {% for status in hasil_prescreening_dukcapil_options %}
                            <option value="{{ status }}">{{ status }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-tasks mr-1 text-primary"></i> Status Aplikasi *
                        </label>
                        <select name="status_aplikasi" id="status_aplikasi" required
                            class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-primary transition-all">
                            <option value="">-- Pilih Status Aplikasi --</option>
                            {% for status in status_aplikasi_options %}
                            <option value="{{ status }}">{{ status }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="flex justify-between mt-6">
                    <button type="button" onclick="prevStep(2)"
                        class="px-8 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition-colors flex items-center space-x-2">
                        <i class="fas fa-arrow-left"></i>
                        <span>Kembali</span>
                    </button>
                    <button type="submit" id="submitBtn"
                        class="px-8 py-3 bg-gradient-to-r from-primary to-purple-600 text-white rounded-lg font-semibold hover:from-primaryDark hover:to-purple-700 transition-all transform hover:scale-105 material-shadow-lg flex items-center space-x-2">
                        <i class="fas fa-magic"></i>
                        <span>Analisis Sekarang</span>
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Result Modal -->
<div id="resultModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
    <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto material-shadow-lg fade-in">
        <div class="sticky top-0 bg-gradient-to-r from-primary to-purple-600 text-white p-6 rounded-t-2xl">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-chart-pie text-3xl"></i>
                    <div>
                        <h3 class="text-2xl font-bold">Hasil Analisis</h3>
                        <p class="text-purple-200 text-sm">Prediksi Kredit</p>
                    </div>
                </div>
                <button onclick="closeModal()" class="text-white hover:bg-white/20 p-2 rounded-full transition-colors">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
        </div>

        <div id="resultContent" class="p-6">
            <!-- Will be filled by JavaScript -->
        </div>

        <div class="border-t p-6 bg-gray-50 rounded-b-2xl flex space-x-3">
            <button onclick="closeModal()"
                class="flex-1 px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition-colors">
                <i class="fas fa-times mr-2"></i> Tutup
            </button>
            <button onclick="printResult()"
                class="flex-1 px-6 py-3 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600 transition-colors">
                <i class="fas fa-print mr-2"></i> Cetak
            </button>
            <a href="/predict"
                class="flex-1 px-6 py-3 bg-primary text-white rounded-lg font-semibold hover:bg-primaryDark transition-colors text-center">
                <i class="fas fa-plus mr-2"></i> Prediksi Baru
            </a>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div id="loadingModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
    <div class="bg-white rounded-2xl p-8 text-center material-shadow-lg">
        <div class="loading-spinner mx-auto mb-4"></div>
        <p class="text-gray-700 font-semibold text-lg">Menganalisis data...</p>
        <p class="text-gray-500 text-sm mt-2">Mohon tunggu sebentar</p>
    </div>
</div>

<style>
    .step-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #e5e7eb;
        color: #6b7280;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        transition: all 0.3s ease;
    }

    .step-indicator.active .step-circle {
        background: #6200ea;
        color: white;
        box-shadow: 0 0 0 4px rgba(98, 0, 234, 0.2);
    }

    .step-indicator.active span {
        color: #6200ea;
        font-weight: bold;
    }

    .radio-card input:checked+.radio-card-inner {
        background: #6200ea;
        color: white;
        border-color: #6200ea;
    }

    .radio-card-inner {
        border: 2px solid #d1d5db;
        padding: 12px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
    }

    .radio-card:hover .radio-card-inner {
        border-color: #6200ea;
        background: #f3f4f6;
    }

    .quick-amount-btn {
        padding: 8px 16px;
        background: #e5e7eb;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        color: #374151;
        transition: all 0.3s ease;
    }

    .quick-amount-btn:hover {
        background: #6200ea;
        color: white;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    let currentStep = 1;

    function nextStep(step) {
        // Validate current step
        const currentForm = document.getElementById(`step${currentStep}`);
        const inputs = currentForm.querySelectorAll('[required]');
        let valid = true;

        inputs.forEach(input => {
            if (!input.value) {
                valid = false;
                input.classList.add('border-red-500');
            } else {
                input.classList.remove('border-red-500');
            }
        });

        if (!valid) {
            showToast('Mohon lengkapi semua field yang wajib diisi', 'error');
            return;
        }

        // Hide current step
        document.getElementById(`step${currentStep}`).style.display = 'none';
        document.querySelector(`[data-step="${currentStep}"]`).classList.remove('active');

        // Show next step
        currentStep = step;
        document.getElementById(`step${currentStep}`).style.display = 'block';
        document.querySelector(`[data-step="${currentStep}"]`).classList.add('active');

        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function prevStep(step) {
        document.getElementById(`step${currentStep}`).style.display = 'none';
        document.querySelector(`[data-step="${currentStep}"]`).classList.remove('active');

        currentStep = step;
        document.getElementById(`step${currentStep}`).style.display = 'block';
        document.querySelector(`[data-step="${currentStep}"]`).classList.add('active');

        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function setPlafond(amount) {
        document.getElementById('plafond').value = formatNumber(amount);
    }

    function updateTenorDisplay(value) {
        document.getElementById('tenorDisplay').textContent = value;
    }

    function formatNumber(num) {
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    // Format plafond input
    document.getElementById('plafond').addEventListener('input', function (e) {
        let value = e.target.value.replace(/\D/g, '');
        e.target.value = formatNumber(value);
    });

    // Form submission
    document.getElementById('predictionForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());

        // Remove dots from plafond
        data.plafond = data.plafond.replace(/\./g, '');

        // Show loading
        document.getElementById('loadingModal').classList.remove('hidden');
        document.getElementById('loadingModal').classList.add('flex');

        try {
            const response = await fetch('/predict', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.status === 'success') {
                savePredictionToHistory(result);
                displayResult(result);
                showToast('Analisis berhasil!', 'success');
            } else {
                showToast(result.message || 'Terjadi kesalahan', 'error');
            }
        } catch (error) {
            showToast('Terjadi kesalahan saat memproses data', 'error');
        } finally {
            document.getElementById('loadingModal').classList.add('hidden');
            document.getElementById('loadingModal').classList.remove('flex');
        }
    });

    function displayResult(result) {
        const riskColorMap = {
            'green': { bg: 'bg-green-100', text: 'text-green-800', border: 'border-green-300' },
            'blue': { bg: 'bg-blue-100', text: 'text-blue-800', border: 'border-blue-300' },
            'yellow': { bg: 'bg-yellow-100', text: 'text-yellow-800', border: 'border-yellow-300' },
            'orange': { bg: 'bg-orange-100', text: 'text-orange-800', border: 'border-orange-300' },
            'red': { bg: 'bg-red-100', text: 'text-red-800', border: 'border-red-300' }
        };

        const riskColor = riskColorMap[result.risk_color];
        const predictionColor = result.prediction === 'Lancar' ? 'green' : 'red';
        const predictionIcon = result.prediction === 'Lancar' ? 'check-circle' : 'exclamation-triangle';

        const html = `
            <div class="space-y-6">
                <!-- Main Prediction -->
                <div class="text-center p-8 bg-gradient-to-br from-${predictionColor}-50 to-${predictionColor}-100 rounded-xl border-2 border-${predictionColor}-300">
                    <i class="fas fa-${predictionIcon} text-${predictionColor}-600 text-6xl mb-4"></i>
                    <h3 class="text-4xl font-bold text-${predictionColor}-800 mb-2">${result.prediction}</h3>
                    <p class="text-${predictionColor}-600 font-medium">Status Prediksi Kredit</p>
                </div>
                
                <!-- Risk Level -->
                <div class="border-2 rounded-xl p-6 ${riskColor.bg} ${riskColor.border}">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium ${riskColor.text} mb-1">Tingkat Risiko</p>
                            <p class="text-2xl font-bold ${riskColor.text}">${result.risk_level}</p>
                        </div>
                        <i class="fas fa-exclamation-triangle text-4xl ${riskColor.text}"></i>
                    </div>
                </div>
                
                <!-- Probability -->
                <div class="border rounded-xl p-6">
                    <h4 class="font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-percentage text-primary mr-2"></i>
                        Probabilitas
                    </h4>
                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between mb-2">
                                <span class="text-sm font-medium text-gray-700">Kredit Lancar</span>
                                <span class="text-sm font-bold text-green-600">${result.probability.lancar}%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3">
                                <div class="bg-green-500 h-3 rounded-full transition-all duration-1000" style="width: ${result.probability.lancar}%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between mb-2">
                                <span class="text-sm font-medium text-gray-700">Kredit Macet</span>
                                <span class="text-sm font-bold text-red-600">${result.probability.tidak_lancar}%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3">
                                <div class="bg-red-500 h-3 rounded-full transition-all duration-1000" style="width: ${result.probability.tidak_lancar}%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Recommendation -->
                <div class="bg-blue-50 border-2 border-blue-200 rounded-xl p-6">
                    <h4 class="font-bold text-blue-900 mb-3 flex items-center">
                        <i class="fas fa-lightbulb text-blue-600 mr-2 text-xl"></i>
                        Rekomendasi
                    </h4>
                    <p class="text-gray-700">${result.rekomendasi}</p>
                </div>
                
                <!-- Summary -->
                <div class="border rounded-xl p-6">
                    <h4 class="font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-list-ul text-primary mr-2"></i>
                        Ringkasan Data
                    </h4>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Usia:</span>
                            <span class="font-semibold">${result.input_summary.usia} tahun</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Status:</span>
                            <span class="font-semibold">${result.input_summary.status_pernikahan}</span>
                        </div>
                        <div class="col-span-2">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Pekerjaan:</span>
                                <span class="font-semibold text-right">${result.input_summary.pekerjaan}</span>
                            </div>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Plafond:</span>
                            <span class="font-semibold">${result.input_summary.plafond}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Tenor:</span>
                            <span class="font-semibold">${result.input_summary.jangka_waktu}</span>
                        </div>
                        <div class="col-span-2">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Produk:</span>
                                <span class="font-semibold">${result.input_summary.produk} - ${result.input_summary.sub_produk}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        document.getElementById('resultContent').innerHTML = html;
        document.getElementById('resultModal').classList.remove('hidden');
        document.getElementById('resultModal').classList.add('flex');
    }

    function closeModal() {
        document.getElementById('resultModal').classList.add('hidden');
        document.getElementById('resultModal').classList.remove('flex');

        // Reset form
        document.getElementById('predictionForm').reset();
        currentStep = 1;
        document.querySelectorAll('.form-step').forEach(step => step.style.display = 'none');
        document.getElementById('step1').style.display = 'block';
        document.querySelectorAll('.step-indicator').forEach(ind => ind.classList.remove('active'));
        document.querySelector('[data-step="1"]').classList.add('active');
    }

    function printResult() {
        window.print();
    }
</script>
{% endblock %}