{% extends "base.html" %}

{% block title %}Dashboard - Sistem Prediksi Kredit{% endblock %}

{% block content %}
<div class="space-y-6 fade-in">
    <!-- Welcome Card -->
    <div class="card-android material-shadow p-6 bg-gradient-to-r from-primary to-purple-600 text-white">
        <div class="flex items-center justify-between">
            <div>
                <h2 class="text-2xl font-bold mb-2">Selamat Datang di NPL Predictor</h2>
                <p class="text-purple-100">Sistem prediksi kredit berbasis Machine Learning</p>
                <div class="mt-4 flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-calendar-day"></i>
                        <span id="currentDate"></span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-clock"></i>
                        <span id="currentTime"></span>
                    </div>
                </div>
            </div>
            <div class="hidden md:block">
                <i class="fas fa-chart-line text-8xl opacity-20"></i>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="card-android material-shadow p-6 border-l-4 border-blue-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm font-medium mb-1">Total Prediksi</p>
                    <p class="text-3xl font-bold text-gray-800" id="totalPredictions">0</p>
                    <p class="text-xs text-green-600 mt-1">
                        <i class="fas fa-arrow-up"></i> +12% dari bulan lalu
                    </p>
                </div>
                <div class="bg-blue-100 p-4 rounded-full">
                    <i class="fas fa-file-invoice text-blue-600 text-2xl"></i>
                </div>
            </div>
        </div>

        <div class="card-android material-shadow p-6 border-l-4 border-green-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm font-medium mb-1">Kredit Lancar</p>
                    <p class="text-3xl font-bold text-gray-800" id="lancarCount">0</p>
                    <p class="text-xs text-gray-500 mt-1" id="lancarPercentage">0% dari total</p>
                </div>
                <div class="bg-green-100 p-4 rounded-full">
                    <i class="fas fa-check-circle text-green-600 text-2xl"></i>
                </div>
            </div>
        </div>

        <div class="card-android material-shadow p-6 border-l-4 border-red-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm font-medium mb-1">Kredit Macet</p>
                    <p class="text-3xl font-bold text-gray-800" id="macetCount">0</p>
                    <p class="text-xs text-gray-500 mt-1" id="macetPercentage">0% dari total</p>
                </div>
                <div class="bg-red-100 p-4 rounded-full">
                    <i class="fas fa-exclamation-circle text-red-600 text-2xl"></i>
                </div>
            </div>
        </div>

        <div class="card-android material-shadow p-6 border-l-4 border-purple-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm font-medium mb-1">Akurasi Model</p>
                    <p class="text-3xl font-bold text-gray-800">{{ (metadata.accuracy * 100)|round(1) }}%</p>
                    <p class="text-xs text-purple-600 mt-1">
                        <i class="fas fa-star"></i> Excellent
                    </p>
                </div>
                <div class="bg-purple-100 p-4 rounded-full">
                    <i class="fas fa-robot text-purple-600 text-2xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Prediction Trend Chart -->
        <div class="card-android material-shadow p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-gray-800">
                    <i class="fas fa-chart-line text-primary mr-2"></i>
                    Tren Prediksi
                </h3>
                <select
                    class="text-sm border border-gray-300 rounded-lg px-3 py-1 focus:outline-none focus:ring-2 focus:ring-primary">
                    <option>7 Hari Terakhir</option>
                    <option>30 Hari Terakhir</option>
                    <option>90 Hari Terakhir</option>
                </select>
            </div>
            <div style="height: 250px;">
                <canvas id="trendChart"></canvas>
            </div>
        </div>

        <!-- Status Distribution Chart -->
        <div class="card-android material-shadow p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-gray-800">
                    <i class="fas fa-chart-pie text-primary mr-2"></i>
                    Distribusi Status
                </h3>
                <button class="text-sm text-primary hover:text-primaryDark font-medium">
                    <i class="fas fa-sync-alt mr-1"></i> Refresh
                </button>
            </div>
            <div style="height: 250px;">
                <canvas id="distributionChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Model Performance Metrics -->
    <div class="card-android material-shadow p-6">
        <h3 class="text-lg font-bold text-gray-800 mb-6">
            <i class="fas fa-award text-primary mr-2"></i>
            Performa Model Machine Learning
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div class="text-center">
                <div class="relative inline-block">
                    <svg class="transform -rotate-90 w-24 h-24">
                        <circle cx="48" cy="48" r="40" stroke="#e5e7eb" stroke-width="8" fill="none" />
                        <circle cx="48" cy="48" r="40" stroke="#6200ea" stroke-width="8" fill="none"
                            stroke-dasharray="{{ (metadata.accuracy * 251.2)|round(2) }} 251.2"
                            stroke-linecap="round" />
                    </svg>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <span class="text-xl font-bold text-primary">{{ (metadata.accuracy * 100)|round(0) }}%</span>
                    </div>
                </div>
                <p class="mt-3 font-semibold text-gray-700">Accuracy</p>
                <p class="text-xs text-gray-500">Ketepatan prediksi</p>
            </div>

            <div class="text-center">
                <div class="relative inline-block">
                    <svg class="transform -rotate-90 w-24 h-24">
                        <circle cx="48" cy="48" r="40" stroke="#e5e7eb" stroke-width="8" fill="none" />
                        <circle cx="48" cy="48" r="40" stroke="#10b981" stroke-width="8" fill="none"
                            stroke-dasharray="{{ (metadata.precision * 251.2)|round(2) }} 251.2"
                            stroke-linecap="round" />
                    </svg>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <span class="text-xl font-bold text-green-600">{{ (metadata.precision * 100)|round(0) }}%</span>
                    </div>
                </div>
                <p class="mt-3 font-semibold text-gray-700">Precision</p>
                <p class="text-xs text-gray-500">Presisi hasil</p>
            </div>

            <div class="text-center">
                <div class="relative inline-block">
                    <svg class="transform -rotate-90 w-24 h-24">
                        <circle cx="48" cy="48" r="40" stroke="#e5e7eb" stroke-width="8" fill="none" />
                        <circle cx="48" cy="48" r="40" stroke="#f59e0b" stroke-width="8" fill="none"
                            stroke-dasharray="{{ (metadata.recall * 251.2)|round(2) }} 251.2" stroke-linecap="round" />
                    </svg>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <span class="text-xl font-bold text-orange-600">{{ (metadata.recall * 100)|round(0) }}%</span>
                    </div>
                </div>
                <p class="mt-3 font-semibold text-gray-700">Recall</p>
                <p class="text-xs text-gray-500">Deteksi lengkap</p>
            </div>

            <div class="text-center">
                <div class="relative inline-block">
                    <svg class="transform -rotate-90 w-24 h-24">
                        <circle cx="48" cy="48" r="40" stroke="#e5e7eb" stroke-width="8" fill="none" />
                        <circle cx="48" cy="48" r="40" stroke="#3b82f6" stroke-width="8" fill="none"
                            stroke-dasharray="{{ (metadata.f1_score * 251.2)|round(2) }} 251.2"
                            stroke-linecap="round" />
                    </svg>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <span class="text-xl font-bold text-blue-600">{{ (metadata.f1_score * 100)|round(0) }}%</span>
                    </div>
                </div>
                <p class="mt-3 font-semibold text-gray-700">F1-Score</p>
                <p class="text-xs text-gray-500">Harmonic mean</p>
            </div>
        </div>
    </div>

    <!-- Recent Predictions -->
    <div class="card-android material-shadow p-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold text-gray-800">
                <i class="fas fa-history text-primary mr-2"></i>
                Prediksi Terbaru
            </h3>
            <a href="/history" class="text-sm text-primary hover:text-primaryDark font-medium">
                Lihat Semua <i class="fas fa-arrow-right ml-1"></i>
            </a>
        </div>
        <div id="recentPredictions" class="space-y-3">
            <!-- Will be populated by JavaScript -->
            <div class="text-center py-8 text-gray-500">
                <i class="fas fa-inbox text-4xl mb-2"></i>
                <p>Belum ada prediksi</p>
                <p class="text-sm mt-1">Mulai dengan membuat prediksi baru</p>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <a href="/predict"
            class="card-android material-shadow p-6 hover:bg-primary hover:text-white transition-all group">
            <div class="flex items-center space-x-4">
                <div class="bg-primary group-hover:bg-white p-4 rounded-full transition-colors">
                    <i class="fas fa-plus text-white group-hover:text-primary text-2xl transition-colors"></i>
                </div>
                <div>
                    <h4 class="font-bold text-lg">Prediksi Baru</h4>
                    <p class="text-sm text-gray-500 group-hover:text-purple-100">Buat prediksi kredit</p>
                </div>
            </div>
        </a>

        <a href="/analytics"
            class="card-android material-shadow p-6 hover:bg-green-500 hover:text-white transition-all group">
            <div class="flex items-center space-x-4">
                <div class="bg-green-500 group-hover:bg-white p-4 rounded-full transition-colors">
                    <i class="fas fa-chart-bar text-white group-hover:text-green-500 text-2xl transition-colors"></i>
                </div>
                <div>
                    <h4 class="font-bold text-lg">Analitik</h4>
                    <p class="text-sm text-gray-500 group-hover:text-green-100">Lihat statistik detail</p>
                </div>
            </div>
        </a>

        <a href="/about"
            class="card-android material-shadow p-6 hover:bg-blue-500 hover:text-white transition-all group">
            <div class="flex items-center space-x-4">
                <div class="bg-blue-500 group-hover:bg-white p-4 rounded-full transition-colors">
                    <i class="fas fa-info-circle text-white group-hover:text-blue-500 text-2xl transition-colors"></i>
                </div>
                <div>
                    <h4 class="font-bold text-lg">Info Model</h4>
                    <p class="text-sm text-gray-500 group-hover:text-blue-100">Detail model ML</p>
                </div>
            </div>
        </a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Update clock
    function updateClock() {
        const now = new Date();
        document.getElementById('currentDate').textContent = now.toLocaleDateString('id-ID', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        document.getElementById('currentTime').textContent = now.toLocaleTimeString('id-ID');
    }
    updateClock();
    setInterval(updateClock, 1000);

    // Load dashboard statistics
    function loadDashboardStats() {
        const history = getPredictionHistory();

        // Update quick stats
        document.getElementById('totalPredictions').textContent = history.length;

        const lancarCount = history.filter(p => p.prediction === 'Lancar').length;
        const macetCount = history.filter(p => p.prediction === 'Tidak Lancar').length;

        document.getElementById('lancarCount').textContent = lancarCount;
        document.getElementById('macetCount').textContent = macetCount;

        if (history.length > 0) {
            document.getElementById('lancarPercentage').textContent =
                `${((lancarCount / history.length) * 100).toFixed(1)}% dari total`;
            document.getElementById('macetPercentage').textContent =
                `${((macetCount / history.length) * 100).toFixed(1)}% dari total`;
        }

        // Load recent predictions
        loadRecentPredictions(history.slice(0, 5));
    }

    function loadRecentPredictions(predictions) {
        const container = document.getElementById('recentPredictions');

        if (predictions.length === 0) {
            return;
        }

        container.innerHTML = predictions.map(pred => `
            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                <div class="flex items-center space-x-4 flex-1">
                    <div class="bg-${pred.prediction === 'Lancar' ? 'green' : 'red'}-100 p-3 rounded-full">
                        <i class="fas fa-${pred.prediction === 'Lancar' ? 'check' : 'times'} text-${pred.prediction === 'Lancar' ? 'green' : 'red'}-600"></i>
                    </div>
                    <div class="flex-1">
                        <div class="flex items-center space-x-2">
                            <h4 class="font-semibold text-gray-800">${pred.input_summary.pekerjaan}</h4>
                            <span class="text-xs px-2 py-1 rounded-full ${pred.prediction === 'Lancar' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${pred.prediction}
                            </span>
                        </div>
                        <p class="text-sm text-gray-500">${pred.input_summary.plafond} - ${pred.input_summary.jangka_waktu}</p>
                        <p class="text-xs text-gray-400 mt-1">${formatDate(pred.timestamp)}</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-sm font-semibold text-gray-700">Risiko: ${pred.risk_level}</p>
                    <div class="flex items-center justify-end space-x-1 mt-1">
                        <div class="w-16 bg-gray-200 rounded-full h-2">
                            <div class="bg-${pred.risk_color}-500 rounded-full h-2" style="width: ${pred.probability.tidak_lancar}%"></div>
                        </div>
                        <span class="text-xs text-gray-500">${pred.probability.tidak_lancar}%</span>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // Initialize Charts
    function initCharts() {
        const history = getPredictionHistory();

        // Trend Chart
        const trendCtx = document.getElementById('trendChart').getContext('2d');
        const last7Days = [...Array(7)].map((_, i) => {
            const date = new Date();
            date.setDate(date.getDate() - (6 - i));
            return date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short' });
        });

        new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: last7Days,
                datasets: [{
                    label: 'Lancar',
                    data: [12, 19, 15, 25, 22, 30, history.filter(p => p.prediction === 'Lancar').length],
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.4,
                    fill: true
                }, {
                    label: 'Tidak Lancar',
                    data: [3, 5, 4, 7, 6, 8, history.filter(p => p.prediction === 'Tidak Lancar').length],
                    borderColor: '#ef4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });

        // Distribution Chart
        const distCtx = document.getElementById('distributionChart').getContext('2d');
        new Chart(distCtx, {
            type: 'doughnut',
            data: {
                labels: ['Lancar', 'Tidak Lancar'],
                datasets: [{
                    data: [
                        history.filter(p => p.prediction === 'Lancar').length || 65,
                        history.filter(p => p.prediction === 'Tidak Lancar').length || 35
                    ],
                    backgroundColor: ['#10b981', '#ef4444'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }

    // Get counts for charts
    const history = getPredictionHistory();
    const lancarCount = history.filter(p => p.prediction === 'Lancar').length;
    const macetCount = history.filter(p => p.prediction === 'Tidak Lancar').length;

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function () {
        loadDashboardStats();
        initCharts();
    });
</script>
{% endblock %}